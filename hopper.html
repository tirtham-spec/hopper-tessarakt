<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tessarakt Event Hopper Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a56db;
            --primary-dark: #1e40af;
            --secondary: #6b7280;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg-primary: #f9fafb;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .sync-status.syncing { animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover { background: #f3f4f6; }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover { background: #047857; }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover { background: var(--bg-primary); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover { color: var(--primary); }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Main Content */
        .main-content {
            padding: 1.5rem 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-body { padding: 1.5rem; }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.green { background: var(--success); }
        .progress-fill.yellow { background: var(--warning); }
        .progress-fill.red { background: var(--danger); }
        .progress-fill.blue { background: var(--primary); }

        /* Data Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
        }

        tr:hover { background: var(--bg-primary); }

        /* Stage Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-inquiry { background: #fef3c7; color: #92400e; }
        .badge-proposal { background: #dbeafe; color: #1e40af; }
        .badge-negotiation { background: #e0e7ff; color: #3730a3; }
        .badge-won { background: #d1fae5; color: #065f46; }
        .badge-lost { background: #fee2e2; color: #991b1b; }
        .badge-hold { background: #f3f4f6; color: #374151; }

        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* AM Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-item:last-child { border-bottom: none; }

        .leaderboard-rank {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            margin-right: 1rem;
        }

        .leaderboard-rank.gold { background: #f59e0b; }
        .leaderboard-rank.silver { background: #9ca3af; }
        .leaderboard-rank.bronze { background: #d97706; }

        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 600; }
        .leaderboard-stats { font-size: 0.875rem; color: var(--text-secondary); }
        .leaderboard-value { font-weight: 700; font-size: 1.125rem; }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.5rem;
        }

        .calendar-day {
            min-height: 100px;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .calendar-event {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
        }

        .modal-title { font-size: 1.25rem; font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body { padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            position: sticky;
            bottom: 0;
            background: white;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
        }

        /* Section Headers */
        .section-header {
            background: var(--bg-primary);
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 1rem -1.5rem;
            margin-top: 1.5rem;
        }

        /* Setup Screen */
        .setup-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .setup-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .setup-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .setup-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .setup-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .setup-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1001;
        }

        .toast {
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.625rem 1rem;
            padding-left: 2.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main-content { padding: 1rem; }
            .nav-tabs { overflow-x: auto; padding: 0 1rem; }
            .nav-tab { padding: 1rem; white-space: nowrap; }
            .charts-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen">
        <div class="setup-card">
            <div class="setup-icon"><i class="fas fa-plug"></i></div>
            <h1 class="setup-title">Connect to Google Sheets</h1>
            <p class="setup-subtitle">Enter your Google Apps Script Web App URL to connect the dashboard to your hopper data.</p>
            <input type="text" id="apiUrlInput" class="setup-input" placeholder="https://script.google.com/macros/s/...">
            <button class="btn btn-success" style="width: 100%; padding: 1rem;" onclick="connectToSheet()">
                <i class="fas fa-link"></i> Connect Dashboard
            </button>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                Don't have the URL? Follow the setup guide to deploy your Google Apps Script.
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-calendar-check"></i>
                Tessarakt Event Hopper
            </div>
            <div class="header-actions">
                <div id="syncStatus" class="sync-status">
                    <i class="fas fa-check-circle"></i>
                    <span>Synced</span>
                </div>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> New Event
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-tab" data-tab="pipeline" onclick="switchTab('pipeline')">
                <i class="fas fa-funnel-dollar"></i> Pipeline
            </div>
            <div class="nav-tab" data-tab="calendar" onclick="switchTab('calendar')">
                <i class="fas fa-calendar-alt"></i> Calendar
            </div>
            <div class="nav-tab" data-tab="team" onclick="switchTab('team')">
                <i class="fas fa-users"></i> Team Performance
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="metrics-grid" id="metricsGrid"></div>
                <div class="charts-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Pipeline by Stage</span>
                        </div>
                        <div class="card-body" id="stageChart"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Top Account Managers</span>
                        </div>
                        <div class="card-body" id="amLeaderboard"></div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipelineTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Event Pipeline</span>
                        <button class="btn btn-success" onclick="openAddModal()">
                            <i class="fas fa-plus"></i> Add Event
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="filters-bar">
                            <div class="search-wrapper">
                                <i class="fas fa-search"></i>
                                <input type="text" class="search-input" id="searchInput" placeholder="Search events..." oninput="filterEvents()">
                            </div>
                            <select class="form-select" style="width: auto;" id="stageFilter" onchange="filterEvents()">
                                <option value="">All Stages</option>
                            </select>
                            <select class="form-select" style="width: auto;" id="amFilter" onchange="filterEvents()">
                                <option value="">All AMs</option>
                            </select>
                        </div>
                        <div class="table-container" id="eventsTable"></div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendarTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title" id="calendarTitle">February 2025</span>
                        <div>
                            <button class="btn btn-outline" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn btn-outline" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Team Tab -->
            <div id="teamTab" class="tab-content">
                <div class="metrics-grid" id="teamMetrics"></div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Account Manager Performance</span>
                    </div>
                    <div class="card-body" id="teamTable"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Event Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Add New Event</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventRowIndex">

                    <div class="section-header" style="margin-top: 0;">Basic Information</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Client / Brand *</label>
                            <select class="form-select" id="clientName" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Name *</label>
                            <input type="text" class="form-input" id="eventName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Type *</label>
                            <select class="form-select" id="eventType" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client Type</label>
                            <select class="form-select" id="clientType"></select>
                        </div>
                    </div>

                    <div class="section-header">Team Assignment</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Account Manager *</label>
                            <select class="form-select" id="accountManager" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Operations Lead</label>
                            <select class="form-select" id="operationsLead"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Creative Lead</label>
                            <select class="form-select" id="creativeLead"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project Stage *</label>
                            <select class="form-select" id="projectStage" required></select>
                        </div>
                    </div>

                    <div class="section-header">Event Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Event Date</label>
                            <input type="date" class="form-input" id="eventDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event City</label>
                            <input type="text" class="form-input" id="eventCity">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region</label>
                            <select class="form-select" id="region"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client Segment</label>
                            <select class="form-select" id="clientSegment"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">No. of Pax</label>
                            <input type="number" class="form-input" id="noOfPax" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">No. of Days</label>
                            <input type="number" class="form-input" id="noOfDays" value="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Venue Type</label>
                            <select class="form-select" id="venueType"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Per Pax Rate (₹)</label>
                            <input type="number" class="form-input" id="perPaxRate" value="0">
                        </div>
                    </div>

                    <div class="section-header">Cost Breakdown (₹ Lakhs)</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Venue Cost</label>
                            <input type="number" class="form-input" id="venueCost" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Production Cost</label>
                            <input type="number" class="form-input" id="productionCost" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">F&B Cost</label>
                            <input type="number" class="form-input" id="fnbCost" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Artist/Entertainment</label>
                            <input type="number" class="form-input" id="artistCost" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Other Costs</label>
                            <input type="number" class="form-input" id="otherCosts" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agency Fee %</label>
                            <input type="number" class="form-input" id="agencyFee" value="15">
                        </div>
                    </div>

                    <div class="section-header">Conversion Factors</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Confidence Factor (0-1)</label>
                            <input type="number" class="form-input" id="confidenceFactor" step="0.1" min="0" max="1" value="0.2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Factor (0-1)</label>
                            <input type="number" class="form-input" id="timeFactor" step="0.1" min="0" max="1" value="0.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price Factor (0-1)</label>
                            <input type="number" class="form-input" id="priceFactor" step="0.1" min="0" max="1" value="0.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">COGS %</label>
                            <input type="number" class="form-input" id="cogsPercent" step="0.01" min="0" max="1" value="0.7">
                        </div>
                    </div>

                    <div class="section-header">Additional Info</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Closure Quarter</label>
                            <select class="form-select" id="closureQuarter">
                                <option value="">Select</option>
                                <option>Q1 FY26</option>
                                <option>Q2 FY26</option>
                                <option>Q3 FY26</option>
                                <option>Q4 FY26</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Month</label>
                            <input type="text" class="form-input" id="eventMonth" placeholder="e.g., Mar-26">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Action Points / Next Steps</label>
                            <input type="text" class="form-input" id="actionPoints">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Support Required</label>
                            <input type="text" class="form-input" id="supportRequired">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveEvent()">
                    <i class="fas fa-save"></i> Save Event
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============ CONFIGURATION ============
        let API_URL = localStorage.getItem('tessarakt_api_url') || '';
        let appData = { hopper: [], clients: [], dropdowns: {}, dashboard: {} };
        let currentMonth = new Date();

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            if (API_URL) {
                showMainApp();
                refreshData();
            }
        });

        function connectToSheet() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (!url) {
                showToast('Please enter a valid URL', 'error');
                return;
            }
            API_URL = url;
            localStorage.setItem('tessarakt_api_url', url);
            showMainApp();
            refreshData();
        }

        function showMainApp() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // ============ API CALLS ============
        async function apiCall(action, method = 'GET', body = null) {
            updateSyncStatus('syncing');
            try {
                let url = `${API_URL}?action=${action}`;
                let options = { method };

                if (method === 'POST' && body) {
                    options.body = JSON.stringify(body);
                    options.headers = { 'Content-Type': 'application/json' };
                }

                const response = await fetch(url, options);
                const data = await response.json();
                updateSyncStatus('synced');
                return data;
            } catch (error) {
                updateSyncStatus('error');
                showToast('Connection error. Please check your API URL.', 'error');
                throw error;
            }
        }

        async function refreshData() {
            try {
                appData = await apiCall('getAll');
                populateDropdowns();
                renderDashboard();
                renderEventsTable();
                renderCalendar();
                renderTeamPerformance();
                showToast('Data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // ============ UI UPDATES ============
        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.className = `sync-status ${status}`;
            if (status === 'syncing') {
                el.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>Syncing...</span>';
            } else if (status === 'synced') {
                el.innerHTML = '<i class="fas fa-check-circle"></i><span>Synced</span>';
            } else {
                el.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Error</span>';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // ============ DASHBOARD ============
        function renderDashboard() {
            const d = appData.dashboard?.summary || {};
            const metricsHtml = `
                <div class="metric-card">
                    <div class="metric-label">Total Pipeline</div>
                    <div class="metric-value">₹${formatNumber(d.totalPipeline)} L</div>
                    <div class="metric-change positive">${d.totalEvents} events</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Weighted Pipeline</div>
                    <div class="metric-value">₹${formatNumber(d.weightedPipeline)} L</div>
                    <div class="metric-change">${(d.avgConversion * 100).toFixed(0)}% avg conversion</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Hopper Health</div>
                    <div class="metric-value">${((d.hopperHealth || 0) * 100).toFixed(0)}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill ${d.hopperHealth >= 1 ? 'green' : d.hopperHealth >= 0.7 ? 'yellow' : 'red'}"
                             style="width: ${Math.min((d.hopperHealth || 0) * 100, 100)}%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Annual Target</div>
                    <div class="metric-value">₹${formatNumber(d.annualTarget)} L</div>
                    <div class="metric-change">₹${(d.annualTarget / 100).toFixed(0)} Cr</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = metricsHtml;

            // Stage Chart
            const stages = appData.dashboard?.stageWise || {};
            let stageHtml = '';
            const stageOrder = ['01.', '02.', '03.', '04.', '05.', '06.', '07.', '08.', '09.', '10A', '10B', '10C', '11.'];
            const sortedStages = Object.entries(stages).sort((a, b) => {
                const aIdx = stageOrder.findIndex(s => a[0].includes(s));
                const bIdx = stageOrder.findIndex(s => b[0].includes(s));
                return aIdx - bIdx;
            });

            sortedStages.forEach(([stage, data]) => {
                const pct = d.totalPipeline > 0 ? (data.value / d.totalPipeline * 100) : 0;
                stageHtml += `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.875rem;">${stage.split('.')[1]?.trim() || stage}</span>
                            <span style="font-weight: 600;">₹${formatNumber(data.value)} L (${data.count})</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill blue" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('stageChart').innerHTML = stageHtml || '<p>No data</p>';

            // AM Leaderboard
            const ams = appData.dashboard?.amWise || {};
            let amHtml = '';
            const sortedAMs = Object.entries(ams).sort((a, b) => b[1].value - a[1].value);
            sortedAMs.slice(0, 5).forEach(([am, data], idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                amHtml += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank ${rankClass}">${idx + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${am}</div>
                            <div class="leaderboard-stats">${data.count} events | ₹${formatNumber(data.won)} L won</div>
                        </div>
                        <div class="leaderboard-value">₹${formatNumber(data.value)} L</div>
                    </div>
                `;
            });
            document.getElementById('amLeaderboard').innerHTML = amHtml || '<p>No data</p>';
        }

        // ============ EVENTS TABLE ============
        function renderEventsTable() {
            const events = appData.hopper || [];

            // Populate filters
            const stages = [...new Set(events.map(e => e.projectStage).filter(Boolean))];
            const ams = [...new Set(events.map(e => e.accountManager).filter(Boolean))];

            document.getElementById('stageFilter').innerHTML = '<option value="">All Stages</option>' +
                stages.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('amFilter').innerHTML = '<option value="">All AMs</option>' +
                ams.map(a => `<option value="${a}">${a}</option>`).join('');

            filterEvents();
        }

        function filterEvents() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const stage = document.getElementById('stageFilter').value;
            const am = document.getElementById('amFilter').value;

            const filtered = (appData.hopper || []).filter(e => {
                const matchSearch = !search ||
                    e.eventName?.toLowerCase().includes(search) ||
                    e.clientName?.toLowerCase().includes(search);
                const matchStage = !stage || e.projectStage === stage;
                const matchAM = !am || e.accountManager === am;
                return matchSearch && matchStage && matchAM;
            });

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Client</th>
                            <th>AM</th>
                            <th>Stage</th>
                            <th>Event Date</th>
                            <th>Value (₹L)</th>
                            <th>Conv %</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filtered.forEach(e => {
                const badgeClass = getBadgeClass(e.projectStage);
                tableHtml += `
                    <tr>
                        <td><strong>${e.eventName || '-'}</strong></td>
                        <td>${e.clientName || '-'}</td>
                        <td>${e.accountManager || '-'}</td>
                        <td><span class="badge ${badgeClass}">${e.projectStage?.split('.')[1]?.trim() || e.projectStage || '-'}</span></td>
                        <td>${e.eventDate || e.eventMonth || '-'}</td>
                        <td><strong>₹${formatNumber(e.totalProjectValue)}</strong></td>
                        <td>${((e.conversionPercent || 0) * 100).toFixed(0)}%</td>
                        <td>
                            <button class="btn btn-outline" style="padding: 0.25rem 0.5rem;" onclick="editEvent(${e.rowIndex})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline" style="padding: 0.25rem 0.5rem; color: var(--danger);" onclick="deleteEvent(${e.rowIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            document.getElementById('eventsTable').innerHTML = tableHtml;
        }

        function getBadgeClass(stage) {
            if (!stage) return '';
            if (stage.includes('01.') || stage.includes('02.') || stage.includes('03.')) return 'badge-inquiry';
            if (stage.includes('04.') || stage.includes('05.')) return 'badge-proposal';
            if (stage.includes('06.') || stage.includes('07.') || stage.includes('08.')) return 'badge-negotiation';
            if (stage.includes('10A') || stage.includes('WON')) return 'badge-won';
            if (stage.includes('10B') || stage.includes('LOST')) return 'badge-lost';
            if (stage.includes('10C') || stage.includes('HOLD')) return 'badge-hold';
            return 'badge-proposal';
        }

        // ============ CALENDAR ============
        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            document.getElementById('calendarTitle').textContent =
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const events = appData.hopper || [];
            const eventsByDate = {};
            events.forEach(e => {
                if (e.eventDate) {
                    const date = new Date(e.eventDate);
                    const key = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                    if (!eventsByDate[key]) eventsByDate[key] = [];
                    eventsByDate[key].push(e);
                }
            });

            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                .map(d => `<div class="calendar-header">${d}</div>`).join('');

            // Empty cells before first day
            for (let i = 0; i < firstDay.getDay(); i++) {
                html += '<div class="calendar-day" style="background: #f9fafb;"></div>';
            }

            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const key = `${year}-${month}-${day}`;
                const dayEvents = eventsByDate[key] || [];
                html += `
                    <div class="calendar-day">
                        <div class="calendar-day-number">${day}</div>
                        ${dayEvents.slice(0, 3).map(e => `
                            <div class="calendar-event" title="${e.eventName} - ${e.clientName}" onclick="editEvent(${e.rowIndex})">
                                ${e.eventName}
                            </div>
                        `).join('')}
                        ${dayEvents.length > 3 ? `<div style="font-size: 0.7rem; color: var(--text-secondary);">+${dayEvents.length - 3} more</div>` : ''}
                    </div>
                `;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        // ============ TEAM PERFORMANCE ============
        function renderTeamPerformance() {
            const ams = appData.dashboard?.amWise || {};
            const d = appData.dashboard?.summary || {};

            let metricsHtml = `
                <div class="metric-card">
                    <div class="metric-label">Total Team Members</div>
                    <div class="metric-value">${Object.keys(ams).length}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Pipeline per AM</div>
                    <div class="metric-value">₹${formatNumber(d.totalPipeline / Math.max(Object.keys(ams).length, 1))} L</div>
                </div>
            `;
            document.getElementById('teamMetrics').innerHTML = metricsHtml;

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Account Manager</th>
                            <th>Events</th>
                            <th>Pipeline Value</th>
                            <th>Weighted Value</th>
                            <th>Won Value</th>
                            <th>Win Rate</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(ams).sort((a, b) => b[1].value - a[1].value).forEach(([am, data]) => {
                const winRate = data.value > 0 ? (data.won / data.value * 100) : 0;
                tableHtml += `
                    <tr>
                        <td><strong>${am}</strong></td>
                        <td>${data.count}</td>
                        <td>₹${formatNumber(data.value)} L</td>
                        <td>₹${formatNumber(data.weighted)} L</td>
                        <td>₹${formatNumber(data.won)} L</td>
                        <td>
                            <span class="badge ${winRate >= 30 ? 'badge-won' : winRate >= 15 ? 'badge-proposal' : 'badge-inquiry'}">
                                ${winRate.toFixed(0)}%
                            </span>
                        </td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            document.getElementById('teamTable').innerHTML = tableHtml;
        }

        // ============ DROPDOWNS ============
        function populateDropdowns() {
            const dd = appData.dropdowns || {};
            const clients = appData.clients || [];

            populateSelect('clientName', clients.map(c => c.clientName), true);
            populateSelect('eventType', dd.eventTypes);
            populateSelect('clientType', dd.clientTypes);
            populateSelect('accountManager', dd.accountManagers);
            populateSelect('operationsLead', dd.operationsTeam);
            populateSelect('creativeLead', dd.creativeTeam);
            populateSelect('projectStage', dd.projectStages);
            populateSelect('region', dd.regions);
            populateSelect('clientSegment', dd.clientSegments);
            populateSelect('venueType', dd.venueTypes);
        }

        function populateSelect(id, options, allowNew = false) {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">Select...</option>';
            (options || []).forEach(opt => {
                select.innerHTML += `<option value="${opt}">${opt}</option>`;
            });
            if (allowNew) {
                select.innerHTML += '<option value="__NEW__">+ Add New Client</option>';
            }
        }

        // ============ MODAL ============
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventRowIndex').value = '';
            document.getElementById('eventModal').classList.add('active');
        }

        function editEvent(rowIndex) {
            const event = appData.hopper.find(e => e.rowIndex === rowIndex);
            if (!event) return;

            document.getElementById('modalTitle').textContent = 'Edit Event';
            document.getElementById('eventRowIndex').value = rowIndex;

            // Populate form
            Object.keys(event).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (key === 'eventDate' && event[key]) {
                        const date = new Date(event[key]);
                        el.value = date.toISOString().split('T')[0];
                    } else {
                        el.value = event[key] || '';
                    }
                }
            });

            document.getElementById('eventModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        async function saveEvent() {
            const rowIndex = document.getElementById('eventRowIndex').value;
            const eventData = {
                clientName: document.getElementById('clientName').value,
                eventName: document.getElementById('eventName').value,
                eventType: document.getElementById('eventType').value,
                clientType: document.getElementById('clientType').value,
                accountManager: document.getElementById('accountManager').value,
                operationsLead: document.getElementById('operationsLead').value,
                creativeLead: document.getElementById('creativeLead').value,
                projectStage: document.getElementById('projectStage').value,
                eventDate: document.getElementById('eventDate').value,
                eventCity: document.getElementById('eventCity').value,
                region: document.getElementById('region').value,
                clientSegment: document.getElementById('clientSegment').value,
                noOfPax: parseFloat(document.getElementById('noOfPax').value) || 0,
                noOfDays: parseFloat(document.getElementById('noOfDays').value) || 1,
                venueType: document.getElementById('venueType').value,
                perPaxRate: parseFloat(document.getElementById('perPaxRate').value) || 0,
                venueCost: parseFloat(document.getElementById('venueCost').value) || 0,
                productionCost: parseFloat(document.getElementById('productionCost').value) || 0,
                fnbCost: parseFloat(document.getElementById('fnbCost').value) || 0,
                artistCost: parseFloat(document.getElementById('artistCost').value) || 0,
                otherCosts: parseFloat(document.getElementById('otherCosts').value) || 0,
                agencyFee: parseFloat(document.getElementById('agencyFee').value) || 15,
                cogsPercent: parseFloat(document.getElementById('cogsPercent').value) || 0.7,
                confidenceFactor: parseFloat(document.getElementById('confidenceFactor').value) || 0.2,
                timeFactor: parseFloat(document.getElementById('timeFactor').value) || 0.5,
                priceFactor: parseFloat(document.getElementById('priceFactor').value) || 0.5,
                closureQuarter: document.getElementById('closureQuarter').value,
                eventMonth: document.getElementById('eventMonth').value,
                actionPoints: document.getElementById('actionPoints').value,
                supportRequired: document.getElementById('supportRequired').value
            };

            if (!eventData.clientName || !eventData.eventName) {
                showToast('Please fill required fields', 'error');
                return;
            }

            try {
                if (rowIndex) {
                    await apiCall('', 'POST', { action: 'updateEvent', rowIndex: parseInt(rowIndex), event: eventData });
                    showToast('Event updated successfully', 'success');
                } else {
                    await apiCall('', 'POST', { action: 'addEvent', event: eventData });
                    showToast('Event added successfully', 'success');
                }
                closeModal();
                refreshData();
            } catch (error) {
                showToast('Error saving event', 'error');
            }
        }

        async function deleteEvent(rowIndex) {
            if (!confirm('Are you sure you want to delete this event?')) return;

            try {
                await apiCall('', 'POST', { action: 'deleteEvent', rowIndex });
                showToast('Event deleted', 'success');
                refreshData();
            } catch (error) {
                showToast('Error deleting event', 'error');
            }
        }

        // ============ UTILITIES ============
        function formatNumber(num) {
            if (!num || isNaN(num)) return '0';
            return parseFloat(num).toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>
